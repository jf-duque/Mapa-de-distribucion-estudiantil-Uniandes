<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Uniandes Map</title>
    <link rel="stylesheet" type="text/css" href="./inspector.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
    <script src="back.js"></script>

    <style>
        .titleText{
            color: black;
        }
        #imagenEdificio{
            border-radius: 5px;
        }
        .leyenda {
            display: flex;
            align-items: center;
            margin: 10px;
        }

        .color-bar {
            height: 20px;
            width: 200px; /* Ajusta segÃºn tu preferencia */
        }
        p {
            margin-bottom: 5px;
        }

        #game{
            border: 1px solid black;
            padding: 10px;
        }
        
        #options, #buttonPPT {
		    margin: 5px;
		    padding: 10px;
		    font-size: 16px;
		}
        /* Contenedor con scroll */
        .contenedor-scroll {
        padding: 5px;
        max-height: 450px;
        overflow-y: auto;
        scrollbar-width: thin; /* Para navegadores Firefox */
        scrollbar-color: #dcdcdc #f5f5f5; /* Color del scrollbar */
        }

        /* Estilo especÃ­fico para navegadores WebKit (Chrome, Safari) */
        .contenedor-scroll::-webkit-scrollbar {
        width: 5px;
        }

        .contenedor-scroll::-webkit-scrollbar-thumb {
        background-color: #dcdcdc; /* Color del thumb */
        border-radius: 7px;
        }

        .contenedor-scroll::-webkit-scrollbar-track {
        background-color: #343A40; /* Color del track */
        border-radius: 6px;
        }
    </style>
</head>

<body>

    <!-- Jumbotron  -->

    <div class="container-fluid p-5 text-black text-center" style="background-color: #FFF200;">
        <h1 class="titleText">Mapa Uniandes</h1>
        <p class="titleText">Distribucion de estudiantes en el campus y ocupacion de salones!</p> 
    </div>

    <!-- FilterBar  -->

    <div class="row text-center" style="width: 100.8%; display: flex; justify-content: space-between; align-items: right; 
                padding: 10px; background-color: #343A40; color: white; position:sticky;
                top: 0px;">
        <div class="col-2"></div>
        <div class="col-4" style="flex: 0 0 33.33%; box-sizing: border-box; padding: 0 10px;">
            <label for="fechaPicker">Seleccione la fecha:</label>
            <input type="date" id="fechaPicker" value="" style="border-radius: 5px; padding: 3px; text-align: center;" onchange="cargar()"/>
        </div>
        <div class="col-4" style="flex: 0 0 33.33%; box-sizing: border-box; padding: 0 10px; display: flex; align-items: center; ">
            <label for="horaSlider">Hora (aprox.): </label>
            <input type="range" id="horaSlider" min="0" max="23.5" step="0.5" style="width: 60%;" onchange="cargar()"/>
            <span id="horaOutput">00:00</span>
        </div>
        <div class="col-2"></div>
    </div>

    <!-- Content Div  -->

    <div style="padding: 2%;">

        <div class="row">
            <div class="col-2" style="display: flex; flex-direction: column; align-items: center;">
                <div style="position:sticky; top: 83px; display: flex; flex-direction: column; align-items: center; background-color: #343A40;
                            padding: 10px; color: white; border-radius: 5px;">
                    <h4 id="">Informacion:</h4>
                    <p style="margin-bottom: 0%; margin-top: 16px;">Cant. Estudiantes</p>
                    <div class="leyenda">
                        <div class="color-bar" style="background: linear-gradient(to right, #ffff00, #ff0000); border-radius: 5px;"></div>
                    </div>
                    <div class="row" style="width: 100%; ">
                        <div class="col-sm-4" style="text-align: left;">0%</div>
                        <div class="col-sm-4" style="text-align: center;">50%</div>
                        <div class="col-sm-4" style="text-align: right;">100%</div>
                    </div>

                    <div style="width: 100%;" class="contenedor-scroll">
                        <div id="divDatosU" style="text-align: left; background-color: #dcdcdc; width: 100%; padding: 10px; 
                        border-radius: 5px; margin-top: 7px; color: black;"></div>

                        <div id="divDatosE" style="text-align: left; background-color: #dcdcdc; width: 100%; padding: 10px; 
                        border-radius: 5px; margin-top: 7px; color: black;"></div>

                        <div id="divDatosP" style="text-align: left; background-color: #dcdcdc; width: 100%; padding: 10px; 
                        border-radius: 5px; margin-top: 7px; color: black;"></div>
                    </div>

                </div>
            </div>
            <div class="col-10">
                <div class="row">
                    <div class="col-6" style="display: flex; flex-direction: column; align-items: center;">
                        <h4>Vista general del campus</h4>
                        <!-- <div id="mapaContainer" ></div> -->
                        <iframe id="imagenUniversidad" src="./svgUniversidad/universidad.html" width="76%" height="500"></iframe>
                    </div>
                    <div class="col-6" id="divSVG"  style="display: flex; flex-direction: column; align-items: center;">
                        <h4 id="nombreEdificio"></h4>
                        <iframe id="imagenEdificio" src="" width="100%" height="500"></iframe>
                    </div>
                </div>
                <div class="row">
                    <div class="col-6" style="display: flex; flex-direction: column; align-items: center;">
                        <h4 id="nombrePiso"></h4>
                        <iframe id="imagenPiso" src="" width="76%" height="500"></iframe>
                    </div>
                    <div class="col-6" style="display: flex; flex-direction: column; align-items: center;">
                        <h4 id="nombreSalon" style="margin-bottom: 16px;"></h4>
                        <div id="divNoInfoSalon" style=" width: 100%; height: 435.2px; display: none; flex-direction: column; align-items: center;">
                            <h1>
                                Este salÃ³n esta solo y triste como tÃº :/
                            </h1>
                            <hr>
                            <hr>
                            <div id="game" style="display: flex; flex-direction: column; align-items: center;">
                                <h5>Piedra, Papel o Tijeras?</h5>
                                <div id="options">
                                    <button class="buttonPPT" onclick="play('piedra')">ðŸ—¿</button>
                                    <button class="buttonPPT" onclick="play('papel')">ðŸ“„</button>
                                    <button class="buttonPPT" onclick="play('tijeras')">âœ‚</button>
                                </div>
                                <div id="result"></div>
                            </div>
                        </div>
                        <div id="divInfoSalon" style="background-color: #dcdcdc; width: 100%; height: 435.2px; display: none; flex-direction: column;
                                                        padding: 30px; border-radius: 5px;">
                        
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>

        var iframeUniversidad = document.getElementById("imagenUniversidad")
        var iframeEdificio = document.getElementById("imagenEdificio");
        var iframePiso = document.getElementById("imagenPiso");

        window.addEventListener("message", function(event) {

            if(event.source === iframeUniversidad.contentWindow){

                var mensaje = event.data;
                if(mensaje.action === "ModificarEdificio"){

                    var nombreEdificio = mensaje.value;
                    var rutaJSONEdificios = './files/edificios.json';

                    fetch(rutaJSONEdificios)
                        .then(function(response) {
                            return response.json();
                        })
                        .then(function(data) {

                            for (var i = 0; i < data.edificios.length; i++) {
                                var edificio = data.edificios[i];
                                
                                if (edificio.id === nombreEdificio) {

                                var rutaImg = edificio.rutaImgEdificio;
                                var nombreCompleto = edificio.nombre;

                                document.getElementById("nombreEdificio").textContent = nombreCompleto;
                                document.getElementById("imagenEdificio").src = rutaImg;
                                document.getElementById("imagenPiso").src = "";
                                document.getElementById("nombrePiso").textContent = "";
                                document.getElementById("nombreSalon").textContent = "";
                                document.getElementById("divNoInfoSalon").style.display = "none";
                                document.getElementById("divInfoSalon").style.display = "none";
                                
                                document.getElementById("divDatosE").innerHTML='';
                                document.getElementById("divDatosP").innerHTML='';
                                

                                break;
                                }
                            }
                            
                            if (i === data.edificios.length) {
                                document.getElementById("nombreEdificio").textContent = "NO INFO";
                                console.log("No se encontrÃ³ un piso con el nombre " + nombreEdificio);
                                document.getElementById("imagenEdificio").src = "";
                                document.getElementById("imagenPiso").src = "";
                                document.getElementById("nombrePiso").textContent = "";
                                document.getElementById("nombreSalon").textContent = "";

                            }
                        })
                        .catch(function(error) {
                            console.error("Error al cargar el archivo JSON: " + error);
                        });

                }

                else if(mensaje.action === "CargarDatos"){
 
                    var totalEstudaintes = mensaje.total;
                    var divDatosU = document.getElementById("divDatosU");
                    divDatosU.innerHTML = '';

                    var titulo = document.createElement("h6");
                    titulo.textContent = "(Toda la u)";
                    divDatosU.appendChild(titulo);
                    
                    var nuevoParrafo = document.createElement("p");
                    nuevoParrafo.textContent = "Total de estudiantes: " + totalEstudaintes;
                    divDatosU.appendChild(nuevoParrafo);

                    for (var clave in mensaje.value) {
                    if (mensaje.value.hasOwnProperty(clave)) {

                        var porcentaje = ((mensaje.value[clave]/totalEstudaintes)*100).toFixed(1);
                        var nuevoParrafo = document.createElement("p");
                        nuevoParrafo.textContent = "" + (clave).toUpperCase() + ': ' + mensaje.value[clave] + ", " + porcentaje + "%";
                        divDatosU.appendChild(nuevoParrafo);
                        }
                    }
                }


            }

            // Para iframeEdificio
            if (event.source === iframeEdificio.contentWindow) {

                var mensaje = event.data;
                // Verifica la acciÃ³n y el valor del mensaje
                if (mensaje.action === "ModificarPiso") {

                    var nombrePiso = mensaje.value;
                    var rutaJSONPisos = './files/pisos.json';

                    fetch(rutaJSONPisos)
                        .then(function(response) {
                            return response.json();
                        })
                        .then(function(data) {

                            for (var i = 0; i < data.pisos.length; i++) {
                                var piso = data.pisos[i];
                                
                                if (piso.id === nombrePiso) {

                                var rutaImg = piso.rutaImgPiso;
                                var nombreCompleto = piso.nombre
                                document.getElementById("nombreSalon").textContent = "";
                                document.getElementById("nombrePiso").textContent = nombreCompleto;
                                document.getElementById("imagenPiso").src = rutaImg;
                                document.getElementById("divNoInfoSalon").style.display = "none";
                                document.getElementById("divInfoSalon").style.display = "none";
                               
                                window.scrollBy({
                                    top: window.innerHeight,
                                    behavior: 'smooth'
                                });
                                break;
                                }
                            }
                            
                            if (i === data.pisos.length) {
                                document.getElementById("nombrePiso").textContent = "NO INFO";
                                document.getElementById("imagenPiso").src = "";
                                document.getElementById("nombreSalon").textContent = "";
                                console.log("No se encontrÃ³ un piso con el nombre " + nombrePiso);
                            }
                        })
                        .catch(function(error) {
                            console.error("Error al cargar el archivo JSON: " + error);
                        });
                }
                
                else if(mensaje.action === "CargarDatos"){

                var nombrePiso = mensaje.value;
 
                var totalEstudaintes = mensaje.total;
                var divDatosE = document.getElementById("divDatosE");
                divDatosE.innerHTML = '';

                var titulo = document.createElement("h6");
                titulo.textContent = "(Edificio)";
                divDatosE.appendChild(titulo);

                var nuevoParrafo = document.createElement("p");
                nuevoParrafo.textContent = "Total de estudiantes: " + totalEstudaintes;

                divDatosE.appendChild(nuevoParrafo);

                for (var clave in mensaje.value) {
                if (mensaje.value.hasOwnProperty(clave)) {

                    var porcentaje = ((mensaje.value[clave]/totalEstudaintes)*100).toFixed(1);
                    var nuevoParrafo = document.createElement("p");
                    if(porcentaje > 0){
                        nuevoParrafo.textContent = "" + (clave).toUpperCase() + ': ' + mensaje.value[clave] + ", " + porcentaje + "%";
                        divDatosE.appendChild(nuevoParrafo);
                    }
                    
                    }
                }
                }

            }

            // Para iframePiso
            if (event.source === iframePiso.contentWindow) {

            var mensaje = event.data;
            // Verifica la acciÃ³n y el valor del mensaje
            if (mensaje.action === "ModificarSalon") {

                var nombreSalon = mensaje.value;
                document.getElementById("nombreSalon").textContent = nombreSalon;

                fetch('../files/ISISclasses.json')
                .then(response => response.json())
                .then(data => {

                    const classes = data;

                    var fechaPickerValue = document.getElementById('fechaPicker').value;
                    var horaSliderValue = document.getElementById('horaSlider').value;

                    // Separar las horas y los minutos
                    var horas = Math.floor(horaSliderValue);
                    var minutos = (horaSliderValue - horas) * 60;

                    // Formatear la fecha y la hora
                    var horaFormateada = ('0' + horas).slice(-2) + ":" + ('0' + minutos).slice(-2);
                    var fechaFormateada = fechaPickerValue + "T" + horaFormateada + ":00";

                    // Crear un objeto Date a partir de la fecha formateada
                    var currentTime = new Date(fechaFormateada);


                    var currentYear = currentTime.getFullYear();
                    var currentMonth = currentTime.getMonth() + 1;
                    var currentDay = currentTime.getDate();
                    var currentDayName = currentTime.toLocaleString('en-US', { weekday: 'long' }).toLowerCase();

                    let salonEncontrado = false;

                    classes.forEach(course => {
                    course.sections.forEach(section => {
                        section.sessions.forEach(session => {
                        
                        var startTime = new Date(`${currentYear}-${currentMonth}-${currentDay} ${session.startTime}`);
                        var finishTime = new Date(`${currentYear}-${currentMonth}-${currentDay} ${session.finishTime}`);
                        var dayName = session.day.toLowerCase()

                        //console.log((currentTime >= startTime && currentTime <= finishTime) && dayName === currentDayName && session.classroom == nombreSalon);

                        if ((currentTime >= startTime && currentTime <= finishTime) && dayName === currentDayName && session.classroom == nombreSalon) {

                            salonEncontrado = true;

                            console.log(nombreSalon);
                            console.log(session.classroom);

                            document.getElementById("divNoInfoSalon").style.display = "none";


                            className = course.className;
                            semester = course.semester;
                            sectionID = section.sectionID;
                            availableSeats = section.availableSeats;
                            enrolled = section.enrolled;
                            day = session.day;
                            startTime = session.startTime;
                            finishTime = session.finishTime;

                            var divInfoSalon = document.getElementById("divInfoSalon");
                            divInfoSalon.innerHTML = '';
                            divInfoSalon.style.display = 'flex';

                            var pClase = document.createElement("p");
                            pClase.textContent = "Clase: " + className;
                            divInfoSalon.appendChild(pClase);

                            var pSemestre = document.createElement("p");
                            pSemestre.textContent = "Semestre: " + semester;
                            divInfoSalon.appendChild(pSemestre);

                            var pSectionID = document.createElement("p");
                            pSectionID.textContent = "Seccion: " + sectionID;
                            divInfoSalon.appendChild(pSectionID);

                            var pAvailableSeats = document.createElement("p");
                            pAvailableSeats.textContent = "Sillas disponibles: " + availableSeats;
                            divInfoSalon.appendChild(pAvailableSeats);

                            var pEnrolled = document.createElement("p");
                            pEnrolled.textContent = "Inscritos: " + enrolled;
                            divInfoSalon.appendChild(pEnrolled);

                            var pDay = document.createElement("p");
                            pDay.textContent = "Dia: " + day;
                            divInfoSalon.appendChild(pDay);

                            var pStartTime = document.createElement("p");
                            pStartTime.textContent = "Hora inicio: " + startTime;
                            divInfoSalon.appendChild(pStartTime);

                            var pFinishTime = document.createElement("p");
                            pFinishTime.textContent = "Hora fin: " + finishTime;
                            divInfoSalon.appendChild(pFinishTime);

                            return;

                        }
                        if (!salonEncontrado) {
                            var divInfoSalon = document.getElementById("divInfoSalon").style.display = "none";
                            document.getElementById("divNoInfoSalon").style.display = "flex";
                        }
                        });
                    });
                    });

                })
                .catch(error => console.error('Error al leer el archivo:', error));

                }
            
            else if(mensaje.action === "CargarDatos"){

            var totalEstudaintes = mensaje.total;
            var divDatosP = document.getElementById("divDatosP");
            divDatosP.innerHTML = '';
            var titulo = document.createElement("h6");
                titulo.textContent = "(Piso)";
                divDatosP.appendChild(titulo);
            var nuevoParrafo = document.createElement("p");
            nuevoParrafo.textContent = "Total de estudiantes: " + totalEstudaintes;

            divDatosP.appendChild(nuevoParrafo);

            for (var clave in mensaje.value) {
            if (mensaje.value.hasOwnProperty(clave)) {

                var porcentaje = ((mensaje.value[clave]/totalEstudaintes)*100).toFixed(1);
                var nuevoParrafo = document.createElement("p");
                if(porcentaje > 0){
                    nuevoParrafo.textContent = "" + (clave).toUpperCase() + ': ' + mensaje.value[clave] + ", " + porcentaje + "%";
                    divDatosP.appendChild(nuevoParrafo);
                }
                
                }
            }
            }
                
            }
            }

        );

        document.addEventListener('DOMContentLoaded', function() {

            var fechaPicker = document.getElementById('fechaPicker');

            // Obtener la fecha actual
            var fechaActual = new Date();

            var dia = fechaActual.getDate();
            var mes = fechaActual.getMonth() + 1; // Los meses comienzan desde 0
            var anio = fechaActual.getFullYear();

            // Formatea la fecha como "DD/MM/YYYY"
            var fechaFormateada = anio + '-' + mes + '-' + dia;

            // Establecer la fecha actual como valor inicial del date picker
            fechaPicker.value = fechaFormateada;    

        var horaSlider = document.getElementById('horaSlider');
        var horaOutput = document.getElementById('horaOutput');

        // Obtener la hora actual

        var horaActualSlider = new Date();
        var horaActual = horaActualSlider.getHours();
        var minutosActuales = horaActualSlider.getMinutes();
        var valorInicial = horaActual + minutosActuales / 60; // Combina la hora y los minutos

        // Redondea el valor inicial a la hora mÃ¡s cercana con incrementos de 0.5
        var valorRedondeado = Math.round(valorInicial * 2) / 2;

        horaSlider.value = valorRedondeado;


        // Establecer el valor inicial del slider
        var horaActual = Math.round(new Date().getHours() + new Date().getMinutes() / 60) / 0.5 * 0.5;

        // Mostrar la hora inicial
        mostrarHora(horaActual);

        // Manejar cambios en el slider
        horaSlider.addEventListener('input', function() {
            mostrarHora(this.value);
        });

        function mostrarHora(hora) {
            // Formatear la hora como HH:MM
            var horaFormateada = ('0' + Math.floor(hora)).slice(-2) + ":" + (hora % 1 === 0.5 ? '30' : '00');

            // Actualizar el texto de salida
            horaOutput.textContent = horaFormateada;

        }
    });

    var iframeEd = document.getElementById('imagenEdificio');
    var iframeEdCargado = false;

    var iframePs = document.getElementById('imagenPiso');
    var iframePsCargado = false;

    // Agrega un evento para detectar cuando el iframePs se ha cargado
    iframePs.onload = function() {

        // Obtener el valor del date picker y del slider de la hora
        var fechaPickerValue = document.getElementById('fechaPicker').value;
        var horaSliderValue = document.getElementById('horaSlider').value;

        // Separar las horas y los minutos
        var horas = Math.floor(horaSliderValue);
        var minutos = (horaSliderValue - horas) * 60;

        // Formatear la fecha y la hora
        var horaFormateada = ('0' + horas).slice(-2) + ":" + ('0' + minutos).slice(-2);
        var fechaFormateada = fechaPickerValue + "T" + horaFormateada + ":00";

        // Crear un objeto Date a partir de la fecha formateada
        var currentTime = new Date(fechaFormateada);

        iframePs.contentWindow.postMessage(currentTime, '*');
        iframePsCargado = true;
        // Puedes realizar mÃ¡s acciones despuÃ©s de que el iframeEd se ha cargado
    };
    

    // Agrega un evento para detectar cuando el iframeEd se ha cargado
    iframeEd.onload = function() {

        // Obtener el valor del date picker y del slider de la hora
        var fechaPickerValue = document.getElementById('fechaPicker').value;
        var horaSliderValue = document.getElementById('horaSlider').value;

        console.log(horaSliderValue);

        // Separar las horas y los minutos
        var horas = Math.floor(horaSliderValue);
        var minutos = (horaSliderValue - horas) * 60;

        // Formatear la fecha y la hora
        var horaFormateada = ('0' + horas).slice(-2) + ":" + ('0' + minutos).slice(-2);
        var fechaFormateada = fechaPickerValue + "T" + horaFormateada + ":00";

        // Crear un objeto Date a partir de la fecha formateada
        var currentTime = new Date(fechaFormateada);

        iframeEd.contentWindow.postMessage(currentTime, '*');
        iframeEdCargado = true;
        // Puedes realizar mÃ¡s acciones despuÃ©s de que el iframeEd se ha cargado
    };

    function cargar(){
        // Obtener el valor del date picker y del slider de la hora
        var fechaPickerValue = document.getElementById('fechaPicker').value;
        var horaSliderValue = document.getElementById('horaSlider').value;

        // Separar las horas y los minutos
        var horas = Math.floor(horaSliderValue);
        var minutos = (horaSliderValue - horas) * 60;

        // Formatear la fecha y la hora
        var horaFormateada = ('0' + horas).slice(-2) + ":" + ('0' + minutos).slice(-2);
        var fechaFormateada = fechaPickerValue + "T" + horaFormateada + ":00";

        // Crear un objeto Date a partir de la fecha formateada
        var currentTime = new Date(fechaFormateada);

        var iframeUni = document.getElementById('imagenUniversidad');
        // Espera a que el iframeUni se haya cargado

        iframeUni.contentWindow.postMessage(currentTime, '*');
        if(iframeEdCargado){
            console.log('iframe edificio cargado')
            iframeEd.contentWindow.postMessage(currentTime, '*');
        }
        if(iframePsCargado){
            console.log('iframe piso cargado')
            iframePs.contentWindow.postMessage(currentTime, '*');
        }


    }


    //JUEGOOO PPT/////////////////////////////////////////////////////////////////////////////////////////////////////////////

    function play(playerChoice) {
        var choices = ['piedra', 'papel', 'tijeras'];
        var computerChoice = choices[Math.floor(Math.random() * 3)];

        var result = '';

        if (playerChoice === computerChoice) {
            result = 'Â¡Empate!';
        } else if (
            (playerChoice === 'piedra' && computerChoice === 'tijeras') ||
            (playerChoice === 'papel' && computerChoice === 'piedra') ||
            (playerChoice === 'tijeras' && computerChoice === 'papel')
        ) {
            result = 'Â¡Ganaste!';
        } else {
            result = 'Â¡Perdiste!';
        }


        document.getElementById('result').innerText = `Elegiste ${playerChoice}, la computadora eligiÃ³ ${computerChoice}. ${result}`;
    }



    </script>

</body>


<script type="module">

    import define from "./index.js";
    import {Runtime, Library, Inspector} from "./runtime.js";

    const runtime = new Runtime();
    const main = runtime.module(define, Inspector.into(document.body));

</script>   
</html>
